{% extends "base.html" %}
{% load humanize %}
{% block title %}Stock Adjustment (Expired / Damaged){% endblock %}

{% block nav-item %}
<div class="mb-0 font-weight-bold h5 text-gray-500 text-uppercase p-3">
    Stock Adjustment
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- ========== Barcode Scan Form ========== -->
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow mb-4">
        <div class="card-body text-center">

          <form method="POST" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="lookup">

            {% if lookup_form.non_field_errors %}
              <div class="alert alert-danger">
                {{ lookup_form.non_field_errors }}
              </div>
            {% endif %}

            <div class="mb-2">
              {# Render barcode input (widget supplies form-control classes) #}
              {{ lookup_form.barcode }}
              {% for err in lookup_form.barcode.errors %}
                <div class="text-danger small mt-1">{{ err }}</div>
              {% endfor %}
            </div>

            <button type="submit" class="btn btn-primary btn-lg mt-3 w-100">
              Scan / Search Product
            </button>
          </form>

          {% if notFound %}
            <div class="mt-3">
              <div class="alert alert-warning mb-0">PRODUCT NOT FOUND</div>
            </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>

  <!-- ========== Product Found ========== -->
  {% if product %}
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow mb-4">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">
            {{ product.name }} ({{ product.barcode }})
          </h5>
        </div>

        <div class="card-body">

          <!-- Product Summary -->
          <div class="row mb-3">
            <div class="col-md-4">
              <strong>Current Stock:</strong>
              <div><span class="text-primary h5">{{ product.qty }}</span></div>
            </div>

            <div class="col-md-4">
              <strong>Department:</strong>
              <div>{{ product.department.department_name }}</div>
            </div>

            <div class="col-md-4">
              <strong>Supplier:</strong>
              <div>{{ product.supplier.name }}</div>
            </div>
          </div>

          <hr>

          <!-- Adjustment Form -->
          <form method="POST" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="adjust">

            {# product_id hidden field: prefer form-provided hidden, fallback to manual input #}
            {% if adjust_form.product_id %}
              {{ adjust_form.product_id }}
            {% else %}
              <input type="hidden" name="product_id" value="{{ product.id }}">
            {% endif %}

            {# Non-field errors #}
            {% if adjust_form.non_field_errors %}
              <div class="alert alert-danger">
                {{ adjust_form.non_field_errors }}
              </div>
            {% endif %}

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="{{ adjust_form.adjustment_type.id_for_label }}" class="fw-bold">Adjustment Type</label>
                {{ adjust_form.adjustment_type }}
                {% for err in adjust_form.adjustment_type.errors %}
                  <div class="text-danger small mt-1">{{ err }}</div>
                {% endfor %}
              </div>

              <div class="col-md-4 mb-3">
                <label class="fw-bold" for="{% if adjust_form.quantity %}{{ adjust_form.quantity.id_for_label }}{% else %}{{ adjust_form.qty.id_for_label }}{% endif %}">Quantity</label>

                {# Render either quantity or qty depending on what the form exposes #}
                {% if adjust_form.quantity %}
                  {{ adjust_form.quantity }}
                  {% for err in adjust_form.quantity.errors %}
                    <div class="text-danger small mt-1">{{ err }}</div>
                  {% endfor %}
                {% else %}
                  {{ adjust_form.qty }}
                  {% for err in adjust_form.qty.errors %}
                    <div class="text-danger small mt-1">{{ err }}</div>
                  {% endfor %}
                {% endif %}
              </div>

              <div class="col-md-4 mb-3">
                <label for="{{ adjust_form.note.id_for_label }}" class="fw-bold">Note</label>
                {{ adjust_form.note }}
                {% for err in adjust_form.note.errors %}
                  <div class="text-danger small mt-1">{{ err }}</div>
                {% endfor %}
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-danger btn-lg">
                Save & Reduce Stock
              </button>

              <a href="{% url 'stock_adjustment_history_product' product.id %}"
                 class="btn btn-outline-secondary btn-lg ms-2">
                View History
              </a>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div>

{# Optional: small script to focus the barcode field when page loads (if widget autofocus fails) #}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var barcode = document.querySelector('input[name="{{ lookup_form.barcode.html_name }}"]');
    if (barcode) barcode.focus();
  });
</script>
{% endblock %}
