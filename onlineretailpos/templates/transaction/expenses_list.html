{% extends "base.html" %}
{% load static %}
{% block title %}Expenses{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card shadow mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-primary">Expenses</h6>
      <div>
        <a class="btn btn-sm btn-success mr-2" href="{% url 'expenses_add' %}"><i class="fas fa-plus-circle"></i> New Expense</a>
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'profit_loss' %}"><i class="fas fa-chart-line"></i> Profit &amp; Loss</a>
      </div>
    </div>

    <div class="card-body">
      <div class="row mb-3">
        <div class="col-lg-8">
          <div class="table-responsive">
            <table id="expensesTable" class="table table-striped table-hover">
              <thead class="thead-light">
                <tr>
                  <th>#</th>
                  <th>Date</th>
                  <th>Category</th>
                  <th>Amount</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody>
                {% for e in expenses %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ e.created_at|date:"Y-m-d H:i" }}</td>
                  <td>{{ e.get_category_display }}</td>
                  <td>{{ e.amount|floatformat:2 }}</td>
                  <td>{{ e.note|default_if_none:"" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-header">
              <strong>Expenses by Category</strong>
            </div>
            <div class="card-body">
              <div id="expensesPie" style="height:280px;"></div>
              <div class="mt-3 text-muted small">Auto-aggregated from listed expenses</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <strong>Totals</strong>
            </div>
            <div class="card-body">
              <p class="mb-1">Total Expenses:</p>
              <h5 class="text-danger">{{ expenses|length|default:"0" }} items</h5>
              <p class="mb-0">Sum: <strong>
                {% with total=0 %}
                  {% for e in expenses %}
                    {% with total=total|add:e.amount %}
                    {% endwith %}
                  {% endfor %}
                  {{ total|floatformat:2 }}
                {% endwith %}
              </strong></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

{% block script %}
<script>
  // DataTables init
  $(document).ready(function(){
      $('#expensesTable').DataTable({
        "order": [[1, "desc"]],
        "pageLength": 10,
        "lengthChange": false,
        "columnDefs": [
          { "orderable": false, "targets": 4 }
        ]
      });
  });

  // Build JS array of expenses from server-side loop
  const expensesData = [
  {% for e in expenses %}
    {category: "{{ e.get_category_display|escapejs }}", amount: {{ e.amount|floatformat:2 }} },
  {% endfor %}
  ];

  // aggregate by category
  const byCat = {};
  expensesData.forEach(e => {
    const k = e.category || "Other";
    const v = Number(e.amount) || 0;
    byCat[k] = (byCat[k] || 0) + v;
  });
  const labels = Object.keys(byCat);
  const values = labels.map(k => byCat[k]);

  // plotly pie
  const pieData = [{
    values: values,
    labels: labels,
    type: 'pie',
    textinfo: 'label+percent',
    hole: .35,
  }];
  const pieLayout = {
    margin: { t: 10, b: 10, l: 10, r: 10 },
    height: 280,
    showlegend: true
  };
  Plotly.newPlot('expensesPie', pieData, pieLayout, {responsive: true});
</script>
{% endblock %}
{% endblock %}
