{% extends 'base.html' %}

{% block title %}
    Transaction Receipt | Online Retail POS
{% endblock %}

{% block nav-item %}  
    Receipt - {{ transNo }}  
{% endblock %}

{% block content %}  

<!-- Existing Review Receipt Button -->
<a href="/transaction_receipt/{{ transNo }}/print/">
    <button class="btn-lg btn-primary" style="width: 20%; margin-top: 10px; margin-left: 10px;">
        Review / Print
    </button>
</a>

<!-- Auto Print Button for QZ Tray -->
<button id="qzPrintBtn" class="btn-lg btn-success" style="width: 20%; margin-top: 10px; margin-left: 10px;">
    Auto Print
</button>

<!-- Receipt Display -->
<div style="text-align: center; padding-top: 30px;">
    <pre id="receiptContent">{{ receipt }}</pre>
</div>

<!-- QZ Tray JS (from their official CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qz-tray/2.1.0/qz-tray.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const printBtn = document.getElementById('qzPrintBtn');
    // get the visible receipt text (keeps newlines)
    const receiptText = document.getElementById('receiptContent').innerText || "";

    // helper: UTF-8 -> base64 (safe for non-ascii)
    function utf8ToBase64(str) {
        // encodeURIComponent + unescape produce proper bytes for btoa
        return btoa(unescape(encodeURIComponent(str)));
    }

    // Common ESC/POS cutter command (GS V 0 or GS V 1  â€” 0x1D 0x56 0x00)
    function escposCut() {
        return String.fromCharCode(0x1D, 0x56, 0x00);
    }

    // Append a few newlines and a cut to ensure printer prints full body and cuts
    function buildPayload(text) {
        const trailing = "\n\n\n";                // spacing so the paper advances
        const cut = escposCut();
        return text + trailing + cut;
    }

    // Connect to QZ Tray
    qz.websocket.connect().then(() => {
        console.log("QZ Tray connected!");
    }).catch(err => {
        console.error("QZ Tray connection error:", err);
        alert("QZ Tray is not connected. Please make sure the tray app is running.");
    });

    function autoPrint() {
        // Use exact printer name as shown in QZ Tray app
        const printerName = "ZKP8008"; // <-- ensure this matches QZ Tray exactly
        const config = qz.configs.create(printerName);

        // Build payload, encode to base64
        const payload = buildPayload(receiptText);
        const base64 = utf8ToBase64(payload);

        const data = [{
            type: 'raw',
            format: 'base64',
            data: base64
        }];

        qz.print(config, data).then(() => {
            console.log("Printed successfully!");
        }).catch(err => {
            console.error("Printing error:", err);
            alert("Error printing: " + err);
        });
    }

    printBtn.addEventListener('click', autoPrint);
});
</script>


{% endblock content %}
