{% extends 'base.html' %}

{% block title %}
Transactions | Online Retail POS
{% endblock %}

{% block nav-item %}
<div class="mb-0 font-weight-bold h5 text-gray-600 text-uppercase p-3">
    Transactions
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Filter Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div>
          <strong class="text-dark">Filter transactions</strong>
          {% if is_filtered %}
            <div class="small text-muted mt-1">
              Active:
              {% if start_date %}<span class="badge badge-info mr-1">From {{ start_date }}</span>{% endif %}
              {% if end_date %}<span class="badge badge-info">To {{ end_date }}</span>{% endif %}
            </div>
          {% else %}
            <div class="small text-muted mt-1">Showing: <span class="font-weight-medium">All</span></div>
          {% endif %}
        </div>

        <!-- Controls -->
        <div class="mt-2 mt-md-0 d-flex gap-2">
          <div class="btn-group" role="group" aria-label="presets">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="preset-today">Today</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="preset-yesterday">Yesterday</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="preset-week">This Week</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="preset-month">This Month</button>
          </div>

          <div class="btn-group ms-2" role="group" aria-label="export">
            <button type="button" class="btn btn-sm btn-outline-success" id="export-csv" title="Export CSV">
              <i class="fas fa-file-csv"></i> CSV
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" id="export-xlsx" title="Export Excel">
              <i class="fas fa-file-excel"></i> XLSX
            </button>
          </div>

          <a href="{{ request.path }}" class="btn btn-sm btn-outline-secondary ms-2" title="Clear filters">
            <i class="fas fa-undo"></i> Reset
          </a>
        </div>
      </div>

      <!-- Form (GET so values persist in URL) -->
      <form method="get" class="row gx-2 gy-2 align-items-end mt-3" id="trans-filter-form">
        {% comment %} Render form fields (DateSelector etc.) {% endcomment %}
        {% for field in form %}
          <div class="col-12 col-sm-6 col-md-3">
            <label class="form-label small fw-bold text-dark mb-1">{{ field.label }}</label>
            {{ field }}
          </div>
        {% endfor %}

        <div class="col-6 col-md-2 d-grid">
          <button class="btn btn-primary" style="height:40px;">
            <i class="fas fa-filter"></i> Filter
          </button>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>Transaction ID</th>
              <th>Total Sale</th>
              <th>Payment Type</th>
              <th>Date & Time</th>
              <th>Receipt</th>
            </tr>
          </thead>
          <tbody>
            {% for t in transactions %}
            <tr>
              <td>{{ t.transaction_id }}</td>
              <td>{{ t.total_sale }}</td>
              <td>{{ t.payment_type }}</td>
              <td>{{ t.transaction_dt|date:"D, M d Y h:i A" }}</td>
              <td>
                <a class="btn btn-sm btn-outline-primary"
                   href="{% url 'transactionReceipt' transNo=t.transaction_id %}">
                  View Receipt
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                No transactions found for selected date range
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block script %}
  {# flatpickr CSS/JS (optional but gives a nicer date UX). Remove if you prefer native pickers. #}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    (function () {
      // Helper: safely get query param value (server may have prefilled inputs already)
      function qs(name) {
        const urlp = new URLSearchParams(window.location.search);
        return urlp.has(name) ? urlp.get(name) : '';
      }

      // Attach flatpickr to date inputs (keep value format Y-m-d for server)
      const dateInputs = document.querySelectorAll('input[type="date"], input[name*="date"], input[id*="date"]');
      dateInputs.forEach(el => {
        if (el._flatpickr) return;
        flatpickr(el, {
          altInput: true,
          altFormat: "F j, Y",
          dateFormat: "Y-m-d",
          allowInput: true,
          clickOpens: true,
        });
      });

      // Preset button helpers (set start_date/end_date and submit)
      function formatYMD(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      }

      document.getElementById('preset-today').addEventListener('click', function () {
        const today = new Date();
        document.querySelector('input[name="start_date"]').value = formatYMD(today);
        document.querySelector('input[name="end_date"]').value = formatYMD(today);
        document.getElementById('trans-filter-form').submit();
      });

      document.getElementById('preset-yesterday').addEventListener('click', function () {
        const d = new Date();
        d.setDate(d.getDate() - 1);
        document.querySelector('input[name="start_date"]').value = formatYMD(d);
        document.querySelector('input[name="end_date"]').value = formatYMD(d);
        document.getElementById('trans-filter-form').submit();
      });

      document.getElementById('preset-week').addEventListener('click', function () {
        const now = new Date();
        const start = new Date(now);
        start.setDate(now.getDate() - (now.getDay() || 7) + 1); // Monday as start
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        document.querySelector('input[name="start_date"]').value = formatYMD(start);
        document.querySelector('input[name="end_date"]').value = formatYMD(end);
        document.getElementById('trans-filter-form').submit();
      });

      document.getElementById('preset-month').addEventListener('click', function () {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        document.querySelector('input[name="start_date"]').value = formatYMD(start);
        document.querySelector('input[name="end_date"]').value = formatYMD(end);
        document.getElementById('trans-filter-form').submit();
      });

      // Export buttons: build url preserving start_date/end_date, add export param
      function buildExportUrl(format) {
        const params = new URLSearchParams();
        const start = document.querySelector('input[name="start_date"]').value;
        const end = document.querySelector('input[name="end_date"]').value;
        if (start) params.set('start_date', start);
        if (end) params.set('end_date', end);
        params.set('export', format); // your view should detect request.GET.get('export')
        return window.location.pathname + '?' + params.toString();
      }

      document.getElementById('export-csv').addEventListener('click', function () {
        window.location.href = buildExportUrl('csv');
      });
      document.getElementById('export-xlsx').addEventListener('click', function () {
        window.location.href = buildExportUrl('xlsx');
      });

      // Accessibility: Enter submits the form
      document.getElementById('trans-filter-form').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          const tag = e.target.tagName.toLowerCase();
          if (tag !== 'textarea') {
            e.preventDefault();
            this.submit();
          }
        }
      });

    })();
  </script>
{% endblock %}
